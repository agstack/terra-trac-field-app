<!DOCTYPE html>
<!--<html lang="en">-->
<head>
    <title>Plot Visualization</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
        }

        #header {
          text-align: center;
          padding: 10px;
          background-color: #f4f4f4;
          border-bottom: 1px solid #ddd;
        }

        #map {
          height: 90vh;
          width: 100%;
        }

        #status {
          text-align: center;
          padding: 10px;
          background-color: #e7f5e9;
          border-top: 1px solid #ddd;
          color: #333;
          font-weight: bold;
        }

        #status.error {
          background-color: #fbeaea;
          color: #a94442;
        }
    </style>
</head>
<body>
<div id="header">
    <h1 id="header-title">Plot Visualization</h1>
</div>
<div id="map"></div>
<div id="status">Loading map...</div>

<script>
    // Register the service worker for offline caching
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("./service-worker.js")
        .then(() => {
          console.log("Service Worker registered for offline map caching");
        })
        .catch((error) => {
          console.error("Service Worker registration failed:", error);
        });
    }

    // Function to parse query parameters from URL
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        center: params.get("center"),
        zoom: params.get("zoom"),
        lang: params.get("lang") || "en",
        plotId: params.get("plotId"),
      };
    }

    // Extract parameters and initialize the map
    // ✅ Extract parameters
  const { lang, center, zoom, plotId } = getQueryParams();
  console.log('Selected Language:', lang);

    // ✅ Translation Object
    const translations = {
      en: {
        serviceWorkerSuccess:
          "Service Worker registered for offline map caching.",
        serviceWorkerError: "Service Worker registration failed:",
        mapLoaded: "Map loaded successfully!",
        errorLoadingMap: "Error loading map:",
        centroidInfo: "Centroid Information",
        latitude: "Latitude",
        longitude: "Longitude",
        farmInfo: "Farm Information",
        siteId: "Site ID",
        farmer: "Farmer",
        village: "Village",
        district: "District",
        size: "Size",
        accuracy: "Accuracy",
        hectares: "sq units",
        missingCoordinates:
          "Coordinates are missing or empty. Using latitude and longitude instead.",
        header: "Plot Visualization",
        loadingMap: "Loading map...",
      },
      sw: {
        serviceWorkerSuccess:
          "Huduma ya Mtandaoni imesajiliwa kwa uhifadhi nje ya mtandao.",
        serviceWorkerError: "Usajili wa Huduma ya Mtandaoni umeshindikana:",
        mapLoaded: "Ramani imepakiwa kwa mafanikio!",
        errorLoadingMap: "Hitilafu katika kupakia ramani:",
        centroidInfo: "Taarifa ya Kati",
        latitude: "Latitudo",
        longitude: "Longitudo",
        farmInfo: "Taarifa ya Shamba",
        siteId: "Kitambulisho cha Tovuti",
        farmer: "Mkulima",
        village: "Kijiji",
        district: "Wilaya",
        size: "Ukubwa",
        accuracy: "Usahihi",
        hectares: "mita za mraba",
        missingCoordinates:
          "Hakuna viwianishi. Inatumia latitudo na longitudo badala yake.",
        header: "Taswira ya Kiwanja",
        loadingMap: "Ramani inapakia...",
      },
      am: {
        serviceWorkerSuccess: "አገልግሎት ሠራተኛ ለኦፍላይን መሰብሰብ ተመዝግቧል።",
        serviceWorkerError: "አገልግሎት ሠራተኛ መመዝገብ አልተሳካም፦",
        mapLoaded: "ካርታው በተሳካ ሁኔታ ተጭኗል።",
        errorLoadingMap: "ካርታ ማንቀሳቀስ ስህተት፦",
        centroidInfo: "የመሀከል መረጃ",
        latitude: "ኬንትሮዲድ",
        longitude: "ሎንግቲድ",
        farmInfo: "የአርሶ አደር መረጃ",
        siteId: "የአዳራሽ መታወቂያ",
        farmer: "አርሶ አደር",
        village: "መንደር",
        district: "ዞን",
        size: "መጠን",
        accuracy: "ትክክለኛነት",
        hectares: "ኩባንያ",
        missingCoordinates: "አካባቢ የለም። ላቲትዱን እና ሎንግቲዱን በመጠቀም ቀጥሏል።",
        header: "የመሬት ምስል",
        loadingMap: "ካርታ በመጫን ላይ...",
      },
      om: {
        serviceWorkerSuccess:
          "Tajaajila intarneetii bilisummaa keessatti galmaa'e.",
        serviceWorkerError: "Tajaajilli intarneetii galmaa'uu hin dandeenye:",
        mapLoaded: "Kaartaan milkaa'inaan fe'ameera!",
        errorLoadingMap: "Kaartaa fe'uu keessatti dogoggora:",
        centroidInfo: "Odeeffannoo Giddugaleessaa",
        latitude: "Laatiitiiyuudii",
        longitude: "Loongitiiyuudii",
        farmInfo: "Odeeffannoo Qonnaa",
        siteId: "Iddoo Beeksisuu",
        farmer: "Qonnaan Bultoota",
        village: "Ganda",
        district: "Godina",
        size: "Bal'ina",
        accuracy: "Sirrii",
        hectares: "Hektaroota",
        missingCoordinates:
          "Hirriba hin qabu. Laatiitiiyuudii fi Loongitiiyuudii fayyadamuun hojjatame.",
        header: "Ilaalcha Qonnaa",
        loadingMap: "Kaartaa fe'amaa jira...",
      },
    };

    // ✅ Function to get translated text
    function t(key) {
      return translations[lang]?.[key] || translations["en"][key]; // Default to English
    }

    document.addEventListener("DOMContentLoaded", function () {

      document.getElementById('header-title').textContent = t('header');
      document.getElementById('status').textContent = t('loadingMap');

      if (
        plotId &&
        typeof Android !== "undefined" &&
        Android.getSelectedPlot
      ) {
        console.log("Android interface is available.");
        console.log("Plot ID from URL:", plotId);

        const plotJson = Android.getSelectedPlot(parseInt(plotId)); // Use the dynamic ID
        console.log("Plot data:", plotJson);

        if (typeof visualizeData === "function") {
          visualizeData(plotJson);
        } else {
          console.error("visualizeData is not defined.");
        }
      } else {
        console.error(
          "Android interface is not available or plotId is missing."
        );
      }
    });

    function visualizeData(data) {
      const statusElement = document.getElementById("status");
      console.log("Data received:", data);

      try {
        // Parse the data if it is not already in JSON format
        const parsedData = typeof data === "string" ? JSON.parse(data) : data;
        console.log(
          "Parsed data:",
          parsedData.latitude,
          parsedData.longitude
        );

        // Initialize the map centered on the provided latitude and longitude
        const map = L.map("map").setView(
          [parseFloat(parsedData.latitude), parseFloat(parsedData.longitude)],
          18
        );

        // Add a tile layer to the map
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        // Default street view layer
        window.streetLayer = L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution: "© OpenStreetMap contributors",
          }
        ).addTo(map);

        // Satellite view layer
        window.satelliteLayer = L.tileLayer(
          "https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
          {
            maxZoom: 19,
            attribution: "© Google Satellite",
          }
        );

        // Terrain view layer
        window.terrainLayer = L.tileLayer(
          "https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}",
          {
            maxZoom: 19,
            attribution: "© Google Maps",
          }
        );
        // Add terrain layer as the default layer
        window.terrainLayer.addTo(map);

        // Add layer controls
        const baseLayers = {
          Street: window.streetLayer,
          Satellite: window.satelliteLayer,
          Terrain: window.terrainLayer,
        };
        L.control.layers(baseLayers).addTo(map);

        // Handle coordinates
        let latlngs = [];

        if (parsedData.coordinates && parsedData.coordinates.length > 0) {
          latlngs = parsedData.coordinates.map((coord) => [
            parseFloat(coord.first), // Ensure it's a number
            parseFloat(coord.second), // Ensure it's a number
          ]);
        } else if (parsedData.latitude && parsedData.longitude) {
          // Use latitude and longitude as a single point if coordinates are missing
          latlngs = [
            [
              parseFloat(parsedData.latitude),
              parseFloat(parsedData.longitude),
            ],
          ];
          console.warn(
            "Coordinates are missing or empty. Using latitude and longitude instead."
          );
        }

        // Check if latlngs contains valid numbers
        latlngs = latlngs.filter(
          (coord) => !isNaN(coord[0]) && !isNaN(coord[1])
        );

        if (latlngs.length > 0) {
          console.log("Transformed Coordinates:", latlngs);

          // Calculate the centroid (center) of the coordinates
          const centroid = latlngs
            .reduce(
              (acc, curr) => {
                acc[0] += curr[0]; // Sum latitude
                acc[1] += curr[1]; // Sum longitude
                return acc;
              },
              [0, 0]
            )
            .map((sum) => sum / latlngs.length); // Divide sums by the number of points

          console.log("Centroid Coordinates:", centroid);

          // Ensure centroid is valid before proceeding
          if (!isNaN(centroid[0]) && !isNaN(centroid[1])) {
            // Add a marker at the centroid
            const centroidMarker = L.marker(centroid).addTo(map);
            centroidMarker.bindPopup(`
    <b>${t("centroidInfo")}</b><br>
    Latitude: ${centroid[0].toFixed(6)}<br>
    Longitude: ${centroid[1].toFixed(6)}
  `);
          } else {
            console.warn("Invalid centroid calculated.");
          }

          // Draw the polygon (or point if only one lat/lng)
          if (latlngs.length > 1) {
            const polygon = L.polygon(latlngs, { color: "blue" }).addTo(map);
            polygon.bindPopup(`
     <b>${t("farmInfo")}</b><br>
    ${t("siteId")}: ${parsedData.siteId}<br>
    ${t("farmer")}: ${parsedData.farmerName}<br>
    ${t("village")}: ${parsedData.village}<br>
    ${t("district")}: ${parsedData.district}<br>
    ${t("size")}: ${parsedData.size} ${t("hectares")}
  `);
          } else {
            const marker = L.marker(latlngs[0]).addTo(map);
            marker.bindPopup(`
     <b>${t("farmInfo")}</b><br>
    ${t("siteId")}: ${parsedData.siteId}<br>
    ${t("farmer")}: ${parsedData.farmerName}<br>
    ${t("village")}: ${parsedData.village}<br>
    ${t("district")}: ${parsedData.district}<br>
    ${t("size")}: ${parsedData.size} ${t("hectares")}
  `);
          }
        } else {
          console.warn("No valid coordinates available.");
        }

        // Log the farm details for debugging
        console.log("Farm Details:");
        console.log(`Site ID: ${parsedData.siteId}`);
        console.log(`Farmer Name: ${parsedData.farmerName}`);
        console.log(
          `Coordinates: ${
            parsedData.coordinates && parsedData.coordinates.length > 0
              ? JSON.stringify(parsedData.coordinates)
              : "None"
          }`
        );

        // Update the status to indicate the map was loaded successfully
        // ✅ Translate Status Message
        statusElement.textContent = t("mapLoaded");
        statusElement.classList.remove("error");
      } catch (error) {
        // Handle and display errors
        statusElement.textContent = `${t("errorLoadingMap")} ${
          error.message
        }`;
        statusElement.classList.add("error");
        console.error("Error visualizing data:", error);
      }
    }
</script>
</body>
</html>
